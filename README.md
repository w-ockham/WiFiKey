# WiFiKeyとは
最近のトランシーバはリモート接続の機能を持ったものがあり、PCなどに接続せず直接外部からコントロールできます(IC-705,IC-9700など)。これらのトランシーバは専用クライアントソフトを使ってリモートからコントロールや音声による運用ができますが、CW運用はキーボード入力に限定されてしまいます。

WiFiKeyはネットワークを介してリモートにあるトランシーバのキーイングを可能にします。手元のクライアントに縦振電鍵やエレキーを接続し打鍵すると、打鍵タイミングをネットワークを介してサーバーに伝えサーバーはそのタイミングに忠実にトランシーバのキーイングを行います。

またCAT/CI-Vインターフェースをリモート制御する機能を持っています。USB/Bluetoothを使ってトランシーバとサーバーと接続し、ネットワークを介してクライアントを接続したPCからCAT/CI-Vでリグをコントロールします。

![M5ATOMの作成例](images/M5ATOM.jpg "M5AATOMの作成例")

***
# 使い方
## 初期設定
ハードウェア編を参考にサーバー・クライアントの2台を組み立ててください。次にソフトウェア編を参考にインストーラを使ってファームウェアを書き込みます。ファームウェア書き込み後、サーバー(フォトカプラを積んだ側)に電源を接続してください。本体の緑色のランプが一瞬点灯しアクセスポイントとして稼働します。SSID `WiFiKey` パスワード `password` でアクセスポイントに接続後、`http://192.168.4.1/`にアクセスすると以下の表示が現れます。

![起動画面](images/WiFiKey-startup.jpg "サーバー起動画面")

次にボタン`Settings`を押すと以下の設定画面に移ります。

![設定画面](images/wifikey-settings.jpg "設定画面")

設定画面で`MODE`を`Server`に設定してください。次に接続するためのパスワードを`Password`欄に入力してください(`Retype`には確認用に同じパスワードを入れてください)。Wi-Fiステーションとして既設のWi-Fi環境に接続する場合は`Station`の`SSID` `Password`を入力してください。最後に`Save`ボタンを保存して終了です。

次にクライアント(キーを接続する側)を電源に接続しサーバーと同様に設定画面を開きます。サーバーと異なる名前をつけるため、`Name`に`wifikey-client`などの名前を設定します。`Password`はサーバー側に設定したものと同じものを入れてください。次に`Mode`を`Client`に設定すると`Server Name`の欄がアクティブになるので最初に設定したサーバーの名前を入れてください。Wi-Fi設定もサーバーと同様です。こちらも最後に`Save`ボタンを押して設定を保存して終了してください。

## 使ってみよう
サーバー側をトランシーバのキー端子に、クライアント側を縦振電鍵/エレキーなどに接続します。まずサーバー側に電源を接続し緑色のランプが消灯するまで待ってください。次にクライアント側の電源を入れてください（クライアントがネットワーク上でサーバーを探すため先にサーバーの電源を入れておく必要あります）。

キーを打鍵するとクライアントはサーバーとチャレンジ・レスポンス方式による認証を行います。クライアントに設定したサーバー名・パスワードがサーバー側と合致しないと接続できませんので注意してください。認証が成功するとサーバーは接続されたトランシーバのキーイングを始めます。接続後、無操作のまま30分が経過するとタイムアウトとなりますが、打鍵すると再度認証を行います。なお不測の事態を避けるため５秒以上の送信・サーバーのWi-Fi接続の切断時には強制的に送信が止められますのでご注意下さい。

サーバー側`http://wifikey.local`にアクセスすると以下の画面が現れます。

![サーバー画面](images/wifikey-server.jpg "サーバー画面")

各項目の詳細は以下の通りです。

|項目名 | 意味　|
|:------|:----------|
|Name | ホスト名(IPアドレス)|
|Mode | 稼働中のモード(`Server`または`Client`)|
|Client| 接続中のクライアントのアドレス・ポート|
|Timeout|タイムアウトするまでの時間(デフォルトは30分)|
|Estimated Speed|推定キーイング速度 (WPM)|
|Estimated Dash Dot Ratio|長点・短点の比|
|Packet Error|パケットがロストした数|
|Packet Delay|パケットが到達するまでに要する時間|
|Max queue length| サーバーのキューの最大長|
|Max long mark duration| 最も長い長点の長さ|
|Space duration| 符号間のスペースの長さ|

`Packet Error`は受信時にパケットがロスした場合にカウントされます。`Packet Delay`とは符号パケットの到着時刻の間隔からキー入力時の符号間の間隔を引いたもので、この値が大きいほどネットワークの遅延が大きいことを表します。

### リグの切替
またサーバー側が複数のキーイング出力を持っている場合はクライアント側で切り替えることができます。クライアントの本体のボタンをクリックするとLEDの色が赤→緑、緑→赤とチャンネルが切り替わります。LEDが赤の場合サーバーのCh.1側、緑の場合はCh.2側をキーイングします。

### ATUによるチューニング
WiFiKeyはAH-4の制御IFを備えています。クライアントの本体ボタンを長押し(2秒以内)すると現在接続されているチャンネルのトランシーバからチューニング用のキャリアを出力します(CATの場合10W、CI-Vの場合は指定した割合に減力します)。同時にAH-4のSTART/KEYをサーバーが制御しチューニングを開始します。

無事チューニングが完了するとクライアント本体のLEDが緑に点滅するとともに、Web画面に調整後のSWRが表示されます。

## 高度な使い方
### サーバー・クライアントを直接接続する
屋外など接続可能なWi-Fi環境がない場合にはサーバーをアクセスポイントとしてクライアントを直接接続できます。

まずサーバーの設定画面で`Wi-Fi`を`Access Point`に設定してください。次にアクセスポイントのSSID/パスワードを設定するために、`Access Point`の`SSID`,`Password`を設定します。最後にサーバーのアドレス・ポートをを`Local`に設定してください。`Save`で設定を保存してください。再び設定画面で`REBOOT`ボタンを押すとシステムが再起動し設定が有効になります。

次にクライアント側を設定します。サーバーと同様`WiFI`を`Access Point`に設定し`SSID`,`Password`をサーバーで設定したものと同じ値を入力します。次に先程設定したサーバーのアドレス・ポートを`Local`に設定してください。最後に`Save`で設定を保存します。サーバーと同様再起動すると設定が有効になり、直接サーバーに接続されます。

### 複数のSSIDの登録
クライアントをモバイルルーターや自宅以外のWi-Fi環境に接続する場合はSSID2/SSID3に接続するWi-FiのSSID/パスワードを追加登録してください。起動時は一番電波の強いSSIDのアクセスポイントへの接続を試みます。

### パケットタイプの切り替え
`Keyer Parameter`の`Packet`でキーイングを行うタイミングを変更できます。

タイミングには、キー入力の立ち下がり・立ち上がりのエッジでパケットを送出するエッジタイプ`Edge`と、キー入力の立ち上がりのタイミングでキーダウンされていた時間と送出時刻をパケットで送出する時刻タイプ`Time`の2種類があります。

エッジタイプは遅れの少ないキーイングが可能です。しかしステーションモードで既設のWi-Fiアクセスポイントを経由して接続するとパケットの到着時刻にジッタでてしまうためサーバー側で正確な符号を再現できません。サーバーとクライアントを直接接続するアクセスポイントモードで使うようにしてください。

時刻タイプはキーダウンの時間と次の符号までの時刻を保存するためアクセスポイントを経由した場合でも符号の乱れがありません。しかしサーバー側でのバッファリングが必要になるためレイテンシが生じます。バッファーに何シンボル分溜まってから送出するか設定するパラメータ`Symbol`、規定シンボル数以下でも以下の式で求められる所定時間`T` msec経過後に送出を設定するパラメータ`Latency`としてがありますのでネットワーク環境や運用スタイルに合わせて最適な値を設定してください。

```
 T = (長点の長さ(ms) + 符号間の間隔(ms)) * Latency
```

なお、本パラメータはサーバー・クライアント双方で設定できます。クライアント側でパラメータ設定をするとサーバー側にも値が送られ設定されます。

### 外部のネットワークからの接続
自宅内のネットワークにあるサーバーにモバイルルーターなどを経由して外部のネットワークにあるクライアントからアクセスできます。

まずクライアントの設定の設定画面で`Server Address`の`Global`に自宅ネットワークのルーターのグローバルアドレス及びアクセス可能なポートを指定してください。グローバルアドレスの指定にダイナミックDNSを使っている場合はホスト名を指定してください。なお、クライアントは起動時にマルチキャストDNSを使ってローカルネットワーク内で`'Server Name'.local`が存在するか確認します。サーバーが見つからない場合は`Global`で指定されたアドレスへのアクセスを行います。

次にDHCPでサーバーに設定されるアドレスを固定します。サーバーのMACのアドレスを調べ、固定アドレスが振られるようにルーターのDHCPサーバーに登録してください。

次にルーターのポートフォワーディングの設定でグローバルアドレスのポートを、DHCPからサーバーに振られるアドレスのポート(`Server Address`の`Local`のポート部分)にフォワードするように設定してください。

### リグコントロールのリモート化
サーバ側はUSBシリアルケーブル又はBluetoothでトランシーバと接続できます。サーバ側で接続したチャンネルと同じクライアント側のチャンネルを接続しますので、クライアントに接続したPCからリモートでリグコントロールを行うことができます。

#### 設定方法
サーバーの設定画面`Rig Control Interface`で各チャンネルのインターフェースを選択して下さい。`USB`がUSBホストアダプタ、`Bluetooth`がESP32本体のBluetoothになります。`USB`を選択した場合USBシリアル変換ケーブルでリグのRS-232Cインターフェースに接続して下さい。`Bluetooth`を選択した場合はIC-705の設定画面でサーバー名のデバイスが表示されますのでペアリングしてください。

次にクライアント側も各チャンネルをM5ATOMのどのインターフェースに割り当てるか決めます。`USB`とした場合、M5ATOM本体のUSB-Cコネクタ経由で、`Bluetooth`とした場合はM5ATOMのBluetooth経由で接続します。Bluetoothを選択した場合は、Windowsのデバイスに「Bluetoothリンク経由の標準シリアル」というCOMポートが現れます。使用するリグコントロールソフトウェアのシリアルポート設定を適宜おこなってください。

Ctestwin/WSJT-X/JTDX/Logger32/DXLab. Commanderなどで動作確認済みです。なおTurboHAMLOGでは使用できません。シリアルポートアクセス時にESP32がハングアップします。万が一ハングアップした場合は電源を外してください。原因は不明ですがDTR/RTSのタイミングでEPS32がプログラムモードに入ってしまうのではないかと思われます。

#### ATUの設定
WiFiKeyはICOMのATU「AH-4」の制御インターフェースを備えています。設定画面の`ATU Control`でAH-4の接続されているリグのチャンネルを指定して下さい。なお指定したチャンネルがCI-V制御の場合はリグのCI-Vアドレスとキャリア出力時の減力する割合を設定してください。

***
# ハードウェア編
## 必要な部品
クライアント側をM5ATOM、サーバ側をAH-4インターフェースを搭載したESP32で製作する場合の構成です。

1. ESP32搭載評価ボード ([ESP32-WROOM](https://akizukidenshi.com/catalog/g/gM-15675/) x 1
2. [M5 AtomLite](https://www.switch-science.com/catalog/6262/)など) 　x 1
3. Mini USB Hostshiled (MAX3412を使ったもの) x 1
4. フォトカプラ[PC817](https://akizukidenshi.com/catalog/g/gI-13765/) x 4
5. LED x 1
6. 抵抗 100Ω (フォトカプラ・LEDの電流制限用) x2  620Ω(AH-4インターフェース用) x 1
5. ジャック(電鍵・トランシーバ接続用) x 2　、4Pコネクタ(AH-4接続用) x 1 
6. ユニバーサル基板(秋月B基板など) x 1

## 回路構成
以下に回路図を示します。便宜上サーバー・クライアントの双方を同じ図面に載せています。
使用するプラットフォームによってピンアサインが異なりますので注意してください。
![回路図](images/schematics.jpg)

### クライアント側(M5ATOM)
[M5ATOMLite](https://www.switch-science.com/catalog/6262/)と[ATOMICプロトキット](https://www.switch-science.com/catalog/6345/)を使って製作しています。

![M5ATOMの作成例](images/M5ATOM.jpg "M5AATOMの作成例")

ビルドの際に`m5stack-atom`を選択してコンパイルするとGPIOのアサインが以下のように設定されます。

| GPIO | 入出力 | 機能 |
|:-----|:-------|:-----|
| 19 | 入力(内部プルアップ)| キー入力 |
| 27 | 出力 | LED出力 |
| 23 | 出力 | フォトカプラ用出力|

### サーバ側(ESP32-WROVER)
[ESP32-WROVER](https://akizukidenshi.com/catalog/g/gM-15674/)とminiUHSボード(USBホストアダプタ)を使って製作した例です。

![ボード試作例](images/ESP32.jpg)

トランシーバ側は`GPIO 27`を出力をフォトカプラ接続しトランシーバをキーイングします。またクライアント・サーバーともに動作確認のLEDを`GPIO 26`に接続しています。またAH-4の`START`出力に`GPIO 33`,`KEY`入力に`GPIO 16`を使っています。

GPIOの入力は全てESP32内部でプルアップしています。また出力側には電流制限用に100Ωの抵抗を入れています(GPIOの出力を直接フォトカプラやLEDに接続しないでください)。なお、評価ボードによっては書込時にタイミングの問題で失敗するものがありますが、EN-GND間に2.2uF程度のコンデンサを入れると安定するようです。

| GPIO | 入出力 | 機能 |
|:-----|:-------|:-----|
| 16 | 入力(内部プルアップ)| AH-4 KEY|
| 25 | 入力(内部プルアップ)| キー入力 |
| 26 | 出力 | LED出力 |
| 27 | 出力 | フォトカプラ用出力|
| 33 | 出力 | AH-4 START |

USBホストアダプタにはMAX3421を使った一般的なものを使っています。[こちら](https://bit.ly/3AqGBOX)や[こちら](https://bit.ly/39nYyBQ)の記事を参考に接続してください。
またRS-232C・USB変換ケーブルはProlificのPL2303を使用したものを使っています。FTDI等他のチップを使う場合はクラス`RigControl`のメンバ変数`Pl`のクラスを適宜変更してください。

***
# ソフトウェア編
## インストーラによるファームウェア書き込み
インストーラをダウンロードしZIPファイルを展開後、`install.bat`を起動してください。ボードを接続したCOMポートを指定しボードに対応するファームウェアを書き込んでください。次にファイルシステム（ボード共通）を書き込んでください。以上でインストールは完了です。

![インストーラ画面](images/installer.jpg)

## 設定ファイル
WiFiKeyに起動時にNVMに保存されたバージョンと`config.json`のバージョンが異なる場合、以下の設定内容をNVMに読み込みます。画面で設定変更した際に各項目で設定が更新されるタイミングが異なりますので注意してください。

| パラメータ | 初期値 | 意味 |更新タイミング|
|:----------|:-------|:-----|:------------------|
|version|"1.01" |バージョン番号　起動時にNVMに保存されたバージョンとバージョンが異なる場合はconfig.jsonを優先して読み込みます|-|
| keyername | "wifikey" |ホスト名　mDNSの名称として使われます|リブート後|
| keyerpasswd | "passwd" |接続パスワード |設定変更後|
| servermode| "%checked%"|サーバーモード　`%checked%`の場合サーバーとして起動|〃|
| servername| "wifikey" | サーバー名 |設定変更後|
|enablebt| "%checked%"| Bluetooth機能　`%checked%`で起動(サーバーのみ) |〃|
|cl-ch1-media|"USB"|クライアントch.1のインターフェース種類|〃|
|cl-ch2-media|"BT" |クライアントch.2のインターフェース種類|〃|
|cl-ch1-proto|"CAT"|クライアントch.1のプロトコル|〃|
|cl-ch2-proto|"CI-V"|クライアントch.2のプロトコル|〃|
|cl-ch1-baudrate|4800|クライアントch.1の速度|〃|
|cl-ch2-baudrate|115200|クライアントch.2の速度|〃|
|sv-ch1-media|"USB"|サーバーch.1のインターフェース種類|〃|
|sv-ch2-media|"BT" |サーバーch.2のインターフェース種類|〃|
|sv-ch1-proto|"CAT"|サーバーch.1のプロトコル|〃|
|sv-ch2-proto|"CI-V"|サーバーch.2のプロトコル|〃|
|sv-ch1-baudrate|4800|サーバーch.1の速度|〃|
|sv-ch2-baudrate|115200|サーバーch.2の速度|〃|
|sv-atu-1|"AH-4"| サーバ ch.1に接続されたATU |〃|
|sv-atu-addr1|"A4"|ch.1に接続されたリグのCI-Vアドレス|〃|
|sv-atu-reduce1|100|ch.1のチューン時の出力電力(100%)|〃|
|sv-atu-2|"AH-4"| ch.2に接続されたATU|〃|
|sv-atu-addr2| "A4"|ch.2に接続されたリグのCI-Vアドレス|〃|
|sv-atu-reduce2|100|ch.1のチューン時の出力電力(100%)|〃|
| wifistn | %notchecked% | Wi-Fiモード　`%checked%`の場合Wi-Fiステーションとして起動|リブート後|
| SSID1| - | ステーション時のSSID1 |〃|
| passwd1| - | SSID1のパスワード |〃|
| SSID2| -| ステーション時のSSID2 |〃|
| passwd2| - | SSID2のパスワード|〃|
| SSID3| -| ステーション時のSSID3 |〃|
| passwd3| - | SSID3のパスワード|〃|
| APSSID| -| アクセスポイント時のSSID |〃|
| passwdap| - | アクセスポイント時のパスワード|〃|
| pkttypetime|%checked%|パケットタイプ `%checked%`の場合`Time`で起動|設定変更後|
| localaddr|192.168.4.1|サーバーローカルアドレス|リブート後|
| localport|56000|サーバーローカルアドレスのポート|〃|
| globaladdr|192.168.4.1|サーバーグローバルアドレス(FQDNで入力可)|〃|
| globalport|56000|サーバーグローバルポート|〃|
| latency |1| レイテンシ| 設定変更後|
| symbol |2| シンボルウェイト|〃|

## 開発環境について
Visual Studio CodeとPlatformIOを使っています。GitHubからZIPファイルを展開後、`Add Project`で追加してください。 また外部ライブラリとしてArduinoJSON・FastLED・USB Host Shield 2.0を使っています。自動でインストールされない場合は`PIO Home`の`Libraries`から検索してインストールしてください。
次に`Project Environment`でボードを選択してビルド後アップロードをします。最後に`data`フォルダーにある設定画面のHTMLファイル・設定ファイルを`Platoform`の`Upload Filesystem Image`を使ってアップロードして完了です。