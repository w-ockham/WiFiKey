# WiFiKey
## はじめに
最近のトランシーバはリモート接続の機能を持ったものがあり、PC等の接続が不要で直接外部からコントロールすることができます（IC-705,IC-9700など）。

専用クライアントソフトを使ってリモートからリグのコントロールや音声による運用を行うことができますが、CW運用はキーボード入力に限定されるのが欠点です。今回製作するWiFiKeyはネットワークを介してリモートにあるトランシーバのキーイングを可能にします。手元のクライアントに縦振電鍵やエレキーを接続し打鍵すると、打鍵タイミングをネットワークを介してサーバに伝えサーバはそのタイミングに忠実にトランシーバのキーイングを行ないます。

***
## ハードウェア構成
### 必要な部品

1. ESP32を搭載したボード ([ESP32-WROOM](https://akizukidenshi.com/catalog/g/gM-15675/)や[M5 AtomLite](https://www.switch-science.com/catalog/6262/)など) 　x2
2. フォトカプラ[PC817](https://akizukidenshi.com/catalog/g/gI-13765/) x1
3. LED x2
4. 抵抗 100Ω (フォトカプラ・LEDの電流制限用) x3
5. ジャック（電鍵・トランシーバ接続用) x2
6. ブレッドボード等 x 2

### 回路
クライアント側は`GPIO 14`をキー入力として使います。トランシーバ側は`GPIO 27`を出力をフォトカプラ接続しトランシーバをキーイングします。またクライアント・サーバ共に動作確認のLEDを`GPIO 26`に接続しています。

GPIOの入力は全てESP32内部でプルアップしています。また出力側には電流制限用に100Ωの抵抗を入れています(GPIOの出力を直接フォトカプラやLEDに接続しないでください)。尚、評価ボードによっては書込時にタイミングの問題で失敗するものがありますが、EN-GND間に1uF程度のコンデンサを入れると改善するようです。

| GPIO | 入出力 | 機能 |
|:-----|:-------|:-----|
| 14 | 入力（内部プルアップ) | キー入力 |
| 26 | 出力 | LED出力 |
| 27 | 出力 | フォトカプラ用出力|


以下の写真は[ESP32-WROVER](https://akizukidenshi.com/catalog/g/gM-15674/)とブレッドボードを使った制作例です。上側がサーバ、下側がクライアントになります。ATOMLiteなど他のボードを使い場合には使用できるピンに制限がありますのでプログラムを修正しピンアサインを変更してください。一部入力プルアップに対応していないGPIOがありますので注意してください。またキー入力用のGPIOは割り込みのトリガーとして使用しています。

![ボード完成図](images/ESP32.jpg)

***
## ソフトウェアのインストール
###　事前準備
Arduino IDEのボードマネージャを使って使用するボードを追加してください。ライブラリとしてArduinoJSONを使っていますのでこちらもライブラリマネージャを使ってインストールしてください。ESP32は内部にファイルシステムを持っておりバイナリファイルの書き込みとは別にファイルアップロード用のモジュールESP Sketch Data Uploadを使います。こちらを参考に追加してください。

次にGithubからZIPをダウンロードし

### 設定ファイルの修正
WiFiKeyは最初の起動時に`config.json`を読み込みWiFiへの接続を行ないます。利用する環境によって以下の設定を変更してください。
| パラメータ | 初期値 | 意味 |
|:-----|:-------|:-----|
| keyername | wifikey |  |
| keyerpasswd | passwd | LED出力 |
| servermode| %checked%| フォトカプラ用出力|
| servername| wifikey |
| wifistn | %checked% |
| SSID1| - |
| passwd1| - |
| SSID2| -|
| passwd2| - |
| pkttypetime|%checked%|
| localaddr|192.168.1.192|
| localport|56000|
| globaladdr|192.168.1.192|
| globalport|56001|
| latency |2|
| symbol |4|

### ESP32モジュールへの書き込み
srcフォルダ以下のファイルを所定の場所におき、同じフォルダ内にdataファルダを置きます。Arduino IDEでスケッチをコンパイル

### クライアント・サーバの切り替え
起動時にキー入力(`GPIO 14`)のレベルをみて動作モードを決めています。サーバ（リグ側）は`GPIO 14`を`L`に固定しています。サーバは後述するスタンドアロンモードの場合はWiFiのアクセスポイントとしても機能します。

起動時にキー入力(`GPIO 14`)が`H`になっている場合はクライアント(キー側)として動作します。

### WiFiモードの切り替え
起動時に`GPIO 25`が`H`の場合はサーバーは既設のWiFIアクセスポイントへの接続を行います。SSID/パスワードはファイル`config_wifi.h`に記載します。複数のSSID/パスワードを登録することができ、接続時は一番電波強度の高いSSIDのアクセスポイントへの接続を行ないます。

サーバ(リグ側)・クライアント(キー側)のアドレスはアクセスポイントからDHCPで割り当てられます。アドレスが割り当てられるとサーバは変数`keyer_name`で指定された名前をmDNSでネットワーク内に通知します。クライアントは変数`server_name`で指定されたサーバをmDNSを使って検索します。サーバの検索に失敗した場合はローカルネットワーク内にサーバが無いと判断し、変数`keyer_global`で指定されたアドレスのポート`keyer_global_port`への接続を行ないます。

ルータを超えて自宅のプライベートネットワークに設置されたサーバにアクセスする場合には、ルータのグローバルアドレス・ポートを変数`keyer_global`および`global_udpport`に指定してください。
DHCPサーバからサーバに振られるアドレスをMACアドレス等を使って固定化し、固定したアドレスへグローバルアドレスからポートフォワーディングするようルータの設定をしてください。

`GPIO 25`が`L`の場合はサーバはスタンドアロンのWiFiのアクセスポイントとして動作します。サーバのアドレスは変数`ap_server`のアドレスになります(デフォルト`192.168.4.1`)。クライアント（キー側）は変数`ap_client`のアドレス(デフォルト`192.168.4.2`)となります。

いずれのモードも、電源投入後アクセスポイントへの接続が完了するまでの間はLEDが点灯したままになります（WiFI接続が切れた場合も再度接続するまでの間はLEDが点灯したままになります）。

## キーヤーの動作
### クライアントの認証
キーを打鍵するとクライアントはサーバに接続要求を出し認証を開始します。認証が完了するとサーバには他のクライアントからの接続を行うことはできなくなります。接続状態で無送信のまま30分が経過すると認証は無効になり接続は解除されます。再びキーを打鍵すると再認証を行います。また接続中は接続を維持するために15秒おきクライアントからサーバにキープアライブパケットが送られます。

### キーイングの種類
キー入力の立ち下がり・立ち上がりのエッジでUDPパケットを送出するエッジタイプ(起動時`GPIO 12`が`L`)と、キー入力の立ち上がりのタイミングでキーダウンされていた時間と送出時刻をUDPパケットで送出する時刻タイプ(起動時`GPIO 12`が`H`)があります。

エッジタイプはレイテンシの少ないキーイングが可能です。しかしアクセスポイントを経由して接続するとパケットの到着時刻にジッタが生じてしまいサーバ側で符号を再現することができません。スタンドアローンモードでサーバにクライアントを直接繋ぐ場合にお使いください。

時刻タイプはキーダウンの時間と次の符号までの時刻を保存するためアクセスポイントを経由した場合でも符号の乱れがありません。しかしサーバ側でのバッファリングが必要になるためレイテンシが生じます。バッファーに何シンボル分溜まってから送出するか、規定シンボル数以下でも所定時間経過後に送出するか設定するパラメータがありますので適宜調節してください。尚、時刻タイプのパケットがロスした場合は1回に限り再送を行います。

## Webサーバー機能
![サーバー画面](images/server.jpg)

サーバのポート80番でHTTPサーバが動いています。mDNSによりローカルネットワークからはhttp://`keyer_name`.localでアクセスすることができます。
この画面で統計情報の確認やパラメータの設定を行うことができます。

|統計情報　| 意味 |
|:---------|:--------------|
| Client | クライアントのアドレス・ポート |
| Estimated Speed| 推定キーイング速度(WPM) |
| Estimated Dash Dot Ratio| 長点・短点の比 |
| Packet Error | パケットエラー数 |
|Packet Delay |パケットのディレイ(ms)|
| Queue Error | キュー溢れ回数 |
| Max queue length | キューに溜まったシンボルの最大個数 |
| Max mark duration | 長点の長さ(ms)|
| Space duration | 符号間の間隔(ms)

`Packet Error`は受信時にパケットのシーケンス番号が異なる（パケットがロスした）場合にカウントされます。`Packet Delay`とは符号パケットの到着時刻の間隔からキー入力時の符号間の間隔を引いたもので、この値が大きいほどネットワーク等の遅延が大きいことを表します。

|パラメータ     | 意味            |
|:-------------|:----------------|
| Queue Latency| 　キューされてから処理を始める時間|
| Symbol Wait  |　キューに保存するシンボル数 |

`Symbol Wait`とはキー出力までに入力キューに溜めるシンボル(長点・短点）の個数を指します。この値を長くするとネットワーク負荷によるタイミングのズレ（ジッタ）をより吸収することができます。

また入力キューに溜まっているシンボルが`Symbol Wait`以下であっても、シンボルがキューに入ってから以下の式で求められる`T`(ms)経過後はキー出力を行うようパラメータ`Queue Latency`を設定することができます。
```
 T = (長点の長さ(ms) + 符号間の間隔(ms)) * QueueLatency
```

これらのパラメータはネットワークの負荷状況や常用するキーイング速度によって最適な値が変わってきますので適宜修正するようにしてください。